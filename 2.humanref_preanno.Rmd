---
title: "preannotation"
output: html_document
date: "2024-05-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```




```{r, echo=TRUE,error=TRUE}
.libPaths()

########import packages and seurat objects of dataset###########
suppressMessages(library(plotly))
suppressMessages(library(Seurat))
suppressMessages(library(dplyr))
suppressMessages(library(Matrix))
suppressMessages(library(topGO)) #error
suppressMessages(library(org.Hs.eg.db))
suppressMessages(library(gplots))
suppressMessages(library(genefilter))
suppressMessages(library(scran))   #error
library(readxl)

library(devtools)

```

#merge Zhou with other datasets
```{r, echo=TRUE,error=TRUE}
##load dataset
raw_list <- readRDS("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/raw_list_reanno.rds")
zhou <- readRDS( "E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/zhou_reanno2.rds")

##data check
colnames(raw_list$mole@meta.data)
colnames(raw_list$zeng@meta.data)
colnames(raw_list$Ai@meta.data)
colnames(raw_list$tyser@meta.data)
colnames(raw_list$xiang@meta.data)

##unify metadata colnames

raw_list$mole@meta.data$sub_anno <- raw_list$mole@meta.data$anno
raw_list$Ai@meta.data$sub_anno <- raw_list$Ai@meta.data$anno
raw_list$xiang@meta.data$sub_anno <- raw_list$xiang@meta.data$anno

raw_list$xiang@meta.data$sample <- "NA"
raw_list$Ai@meta.data$sample <- "NA"
raw_list$zeng@meta.data$sample <- "NA"
raw_list$tyser@meta.data$sample <- "NA"

raw_list$mole@meta.data$age <- "NA"
raw_list$Ai@meta.data$age <- "NA"
raw_list$zeng@meta.data$age <- "NA"
raw_list$tyser@meta.data$age <- "NA"


newlist <- c("orig.ident","nCount_RNA","nFeature_RNA","sample","stage", "percent.mt","species" ,     "embryo", "platform", "anno","sub_anno", "label1" )

raw_list$mole@meta.data <- raw_list$mole@meta.data[,newlist]
raw_list$zeng@meta.data <- raw_list$zeng@meta.data[,newlist]
raw_list$Ai@meta.data <- raw_list$Ai@meta.data[,newlist]
raw_list$tyser@meta.data <- raw_list$tyser@meta.data[,newlist]
raw_list$xiang@meta.data <- raw_list$xiang@meta.data[,newlist]

############################

colnames(zhou@meta.data)

df <- zhou@meta.data
colnames(df)[15] <- "anno"
df$'anno_sub' <- df$anno

colnames(df)

df <- df[,c(1:3, 12, 14, 5, 6, 7, 8, 15, 16, 13)]
colnames(df)<- newlist

unique(df$anno)
df$label1 <- "NA"

df$label1[which(df$anno=="EPI")]  <- "Epiblast"
df$label1[which(df$anno=="PE")]  <- "Hypoblast"
df$label1[which(df$anno=="TE")]  <- "TE/TrB"

zhou@meta.data <- df

raw_list$zhou <- zhou

######


setwd("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April")
outputDir = getwd()

saveRDS(raw_list, file = "all_reanno.rds")

rm(raw_list)
rm(zhou)

```



#reload the full dataset
```{r, echo=TRUE,error=TRUE}

alldata <- readRDS("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/all_reanno.rds")

```


# data QC
```{r, hight=3, weight=3}

#data check
ncol(alldata$mole)
ncol(alldata$zeng)
ncol(alldata$Ai)
ncol(alldata$tyser)
ncol(alldata$xiang)
ncol(alldata$zhou)

##check QC percent.mt
for (x in 1:length(alldata) )
{
print(paste( names(alldata[x]),length(which(alldata[[x]]$percent.mt < 10)  ) ))  
}

##check QC nFeature_RNA
for (x in 1:length(alldata) )
{
print(paste( names(alldata[x]),length(which(alldata[[x]]$nFeature_RNA >1000)  ) ))  
}

##check QC both
for (x in 1:length(alldata) )
{
print(paste( names(alldata[x]),length(which(alldata[[x]]$nFeature_RNA >2000 & alldata[[x]]$percent.mt < 20)  ) ))  
}


###########plot check
VlnPlot(alldata[[1]], features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(alldata[[2]], features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(alldata[[3]], features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(alldata[[4]], features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(alldata[[5]], features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(alldata[[6]], features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)




```

#dataset plots
```{r, hight=3, weight=3}

##check age#########

age <- do.call(rbind, lapply(1:length(alldata), function(x) {
  
df <- as.data.frame(table(alldata[[x]]$stage) ) 
 df$dataset <- names(alldata[x])
  
 return(df)
}))

age$Var1 <- gsub("D", "E", age$Var1)

# 3: Using RColorBrewer
 library(RColorBrewer) 
colourCount = length(unique(age$Var1))
getPalette = colorRampPalette(brewer.pal(9, "Set1"))


ggplot(data=age, aes(x=dataset, y=Freq, fill=Var1)) +
    geom_bar(stat="identity") +
  scale_fill_manual(values = getPalette(colourCount)) 

##use proportion###########

age <- do.call(rbind, lapply(unique(age$dataset), function(x) {
  
df <- age[which(age$dataset==x),]
df$perct <- df$Freq/sum(df$Freq)
  
 return(df)
}))

age$dataset <- factor(age$dataset, levels = c("xiang","zhou", "Ai", "mole", "tyser", "zeng"))
ggplot(data=age, aes(x=dataset, y=perct, fill=Var1)) +
    geom_bar(stat="identity") +
  scale_fill_manual(values = getPalette(colourCount)) 


##############n_cells###################

ncells <- do.call(rbind, lapply(1:length(alldata), function(x) { 

df <- table(names(alldata[x]), ncol(alldata[[x]]))
df <- as.data.frame(df)

return(df)
 
}
) )

class(ncells$Var2)
ncells$Var2 <- as.numeric(as.character(ncells$Var2))



ncells$Var1 <- factor(ncells$Var1, levels = c("xiang","zhou", "Ai", "mole", "tyser", "zeng"))
colnames(ncells)<- c("dataset", "n_cells")



ggplot(data=ncells, aes(x=dataset, y=n_cells)) +
    geom_bar(stat="identity") +
  scale_fill_manual(values = getPalette(colourCount)) 



```


#Ai dataset
```{r, hight=3, weight=3}

Ai <- subset(alldata$Ai, subset = nFeature_RNA > 2000 & percent.mt < 20)
Ai <- NormalizeData(Ai, normalization.method = "LogNormalize", scale.factor = 10000)

Ai <- FindVariableFeatures(Ai, selection.method = "vst", nfeatures = 2000)

# Identify the 10 most highly variable genes
head(VariableFeatures(Ai), 10)

##PCA
Ai <- ScaleData(Ai)
Ai <- RunPCA(Ai, features = VariableFeatures(object = Ai))

VizDimLoadings(Ai, dims = 1:2, reduction = "pca")

DimPlot(Ai, reduction = "pca") + NoLegend()

DimHeatmap(Ai, dims = 1:6, cells = 500, balanced = TRUE)

ElbowPlot(Ai)

library(clustree)

Ai <- FindNeighbors(Ai, dims = 1:10, k=15) #k set to 10 to make PS population separated
Ai <- FindClusters(Ai, resolution = seq(0.1,0.6,0.1), verbose = FALSE)

clustree(Ai)

Ai <- FindClusters(Ai, resolution = 0.5)
Ai <- RunUMAP(Ai, dims = 1:10)
# individual clusters
DimPlot(Ai, reduction = "umap")
DimPlot(Ai, reduction = "umap", group.by = "stage")


FeaturePlot(Ai, features = c("GATA6", "PDGFRA", "WNT3A", "SP5")) #AVE
FeaturePlot(Ai, features = c("GATA3", "GATA2", "TFAP2A", "CDX2")) #AVE

##################use genemodules#############
Ai <- JoinLayers(Ai)

epi <- list(c("POU5F1","NANOG", "SOX2"))
TE <- list(c("GATA3", "GATA2", "TFAP2A", "TFAP2C", "KRT7"))
PS <- list(c("SP5", "MIXL1", "CDX1", "CDX2", "MESP1", "TBXT"))
ExM <- list(c("VIM",  "KDR", "FLT1", "MEIS2", "COL3A1", "COL6A1", "POSTN"))
VE_YE_AVE <- list(c("IHH", "SOX17", "CDH2", "TTR", "PODXL"))
endo <- list(c("GATA6", "PDGFRA", "GATA4"))

Ai <- AddModuleScore(Ai,
                  features = epi,
                  name="epi_enriched", random.seed = 1)

Ai <- AddModuleScore(Ai,
                  features = PS,
                  name="PS_enriched", random.seed = 1)

Ai <- AddModuleScore(Ai,
                  features = TE,
                  name="TE_AME_enriched", random.seed = 1)

Ai <- AddModuleScore(Ai,
                  features = endo,
                  name="endo_enriched", random.seed = 1)

Ai <- AddModuleScore(Ai,
                  features = VE_YE_AVE,
                  name="VE_YE_AVE_enriched", random.seed = 1)
Ai <- AddModuleScore(Ai,
                  features = ExM,
                  name="ExM_enriched", random.seed = 1)


# Plot scores
FeaturePlot(Ai,
            features = "epi_enriched1", label = TRUE, repel = TRUE) +
            scale_color_distiller(palette = "RdYlBu")

FeaturePlot(Ai,
            features = "TE_AME_enriched1", label = TRUE, repel = TRUE) +
            scale_color_distiller(palette = "RdYlBu")

FeaturePlot(Ai,
            features = "PS_enriched1", label = TRUE, repel = TRUE) +
            scale_color_distiller(palette = "RdYlBu")

FeaturePlot(Ai,
            features = "ExM_enriched1", label = TRUE, repel = TRUE) +
            scale_color_distiller(palette = "RdYlBu")

FeaturePlot(Ai,
            features = "VE_YE_AVE_enriched1", label = TRUE, repel = TRUE) +
            scale_color_distiller(palette = "RdYlBu")

#############relable cells##############################
Ai$anno <- c("TE_AME")
Ai$anno[which(Idents(Ai) %in% c('3', '5'))] <- c("Epiblast")
Ai$anno[which(Idents(Ai) %in% c('8'))] <- c("Primitive streak")
Ai$anno[which(Idents(Ai) %in% c('6'))] <- c("ExM")
Ai$anno[which(Idents(Ai) %in% c('10'))] <- c("AVE_YE")

DimPlot(Ai, reduction = "umap", group.by = "anno")

#Ai[['TE_enriched4']] <- NULL  #remove metadata columns

###################
#Ai <- readRDS("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/Ai_reanno.rds")

#####data check
table(Ai$anno, Ai$stage)

unique(Ai$anno)

alldata$Ai@meta.data$anno <- "NA"
alldata$Ai@meta.data$anno[which(colnames(alldata$Ai)%in% colnames(Ai)[which(Ai$anno=="Epiblast")])] <- "Epiblast"
alldata$Ai@meta.data$anno[which(colnames(alldata$Ai)%in% colnames(Ai)[which(Ai$anno=="Primitive streak")])] <- "Primitive.streak"
alldata$Ai@meta.data$anno[which(colnames(alldata$Ai)%in% colnames(Ai)[which(Ai$anno=="ExM")])] <- "ExE.Mesoderm"
alldata$Ai@meta.data$anno[which(colnames(alldata$Ai)%in% colnames(Ai)[which(Ai$anno=="AVE_YE")])] <- "AVE_YE"
alldata$Ai@meta.data$anno[which(colnames(alldata$Ai)%in% colnames(Ai)[which(Ai$anno=="TE_AME")])] <- "TE_AME"

unique(alldata$Ai@meta.data$anno)
alldata$Ai@meta.data$sub_anno <- alldata$Ai@meta.data$anno

#####data check
table(alldata$Ai$anno, alldata$Ai$stage)

saveRDS(Ai, file = "Ai_reanno.rds")
rm(Ai)

```



# mole dataset
```{r, hight=3, weight=3}

#mole_info <- read_excel("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/data/41467_2021_23758_MOESM4_ESM.xlsx")

mole <- subset(alldata$mole, subset = nFeature_RNA > 2000 & percent.mt < 20)
mole <- subset(mole, subset = stage!="E12")

unique(mole$stage)
ncol(mole) #10341 cells

mole <- NormalizeData(mole, normalization.method = "LogNormalize", scale.factor = 10000)

mole <- FindVariableFeatures(mole, selection.method = "vst", nfeatures = 2000)

# Identify the 10 most highly variable genes
head(VariableFeatures(mole), 10)

##PCA
mole <- ScaleData(mole)
mole <- RunPCA(mole, features = VariableFeatures(object = mole))

DimPlot(mole, reduction = "pca") + NoLegend()

ElbowPlot(mole)


mole <- FindNeighbors(mole, dims = 1:10) 
mole <- FindClusters(mole, resolution = seq(0.1,0.6,0.1), verbose = FALSE)

clustree(mole)

mole <- FindClusters(mole, resolution = 0.5)

mole <- RunUMAP(mole, dims = 1:10)
# individual clusters
DimPlot(mole, reduction = "umap")
DimPlot(mole, reduction = "umap", group.by = "stage")

FeaturePlot(mole, features = c("POU5F1","NANOG", "SOX2"))
FeaturePlot(mole, features = c("SOX17", "GATA4", "PDGFRA", "GATA6"))
FeaturePlot(mole, features = c("CGA", "ANXA1", "LGALS16", "ATF3"))

##################use genemodules#############
mole <- JoinLayers(mole)

VE_YE_AVE <- list(c("IHH", "SOX17", "CDH2", "TTR", "PODXL"))
TE <- list(c("GATA3", "GATA2", "TFAP2A", "TFAP2C", "KRT7"))
CTB <- list(c("PEG10", "FABP5", "HIST1H4C", "KRT19", "TPM1", "CDH1", "ITGA6"))
STB <- list(c("CGA", "PRR9", "ANXA1", "LGALS16", "ATF3"))

epi <- list(c("POU5F1","NANOG", "SOX2"))
Hypo <- list(c("GATA6", "GATA4", "SOX17", "PDGFRA"))
CTB_STB <- list(c("GATA3", "GATA2", "TFAP2A", "TFAP2C", "KRT7","CGA", "PRR9", "ANXA1", "LGALS16", "ATF3","PEG10", "FABP5", "HIST1H4C", "KRT19", "TPM1", "CDH1", "ITGA6"))



mole <- AddModuleScore(mole,
                  features = epi,
                  name="epi_enriched", random.seed = 1)

mole <- AddModuleScore(mole,
                  features = PS,
                  name="PS_enriched", random.seed = 1)

mole <- AddModuleScore(mole,
                  features = TE,
                  name="TE_AME_enriched", random.seed = 1)
mole <- AddModuleScore(mole,
                  features = endo,
                  name="endo_enriched", random.seed = 1)

mole <- AddModuleScore(mole,
                  features = VE_YE_AVE,
                  name="VE_YE_AVE_enriched", random.seed = 1)
mole <- AddModuleScore(mole,
                  features = ExM,
                  name="ExM_enriched", random.seed = 1)

mole <- AddModuleScore(mole,
                  features = CTB_STB,
                  name="CTB_STB_enriched", random.seed = 1)

mole <- AddModuleScore(mole,
                  features = Hypo,
                  name="Hypo_enriched", random.seed = 1)

# Plot scores
FeaturePlot(mole,
            features = "epi_enriched1", label = TRUE, repel = TRUE) +
            scale_color_distiller(palette = "RdYlBu")

FeaturePlot(mole,
            features = "TE_AME_enriched1", label = TRUE, repel = TRUE) +
            scale_color_distiller(palette = "RdYlBu")

FeaturePlot(mole,
            features = "Hypo_enriched1", label = TRUE, repel = TRUE) +
            scale_color_distiller(palette = "RdYlBu")

FeaturePlot(mole,
            features = "CTB_STB_enriched1", label = TRUE, repel = TRUE) +
            scale_color_distiller(palette = "RdYlBu")

FeaturePlot(mole,
            features = "VE_YE_AVE_enriched1", label = TRUE, repel = TRUE) +
            scale_color_distiller(palette = "RdYlBu")

#############relable cells##############################
mole$anno <- c("TE_CTB_STB")
mole$anno[which(Idents(mole) %in% c('8'))] <- c("Epiblast")
mole$anno[which(Idents(mole) %in% c('11'))] <- c("Hypoblast")

DimPlot(mole, reduction = "umap", group.by = "anno")

pt <- table(mole$stage, mole$anno)
pt <- as.data.frame(pt)
pt$Var1 <- as.character(pt$Var1)

ggplot(pt, aes(x = Var2, y = Freq, fill = Var1)) +
  theme_bw(base_size = 15) +
  geom_col(position = "fill", width = 0.5) +
  xlab("Sample") +
  ylab("Proportion") +
  scale_fill_manual(values = brewer.pal(12, "Paired")) +
  theme(legend.title = element_blank())

ggplot(pt, aes(x = Var1, y = Freq, fill = Var2)) +
  theme_bw(base_size = 15) +
  geom_col(position = "fill", width = 0.5) +
  xlab("Sample") +
  ylab("Proportion") +
  scale_fill_manual(values = brewer.pal(12, "Paired")) +
  theme(legend.title = element_blank())


saveRDS(mole, file = "mole_reanno.rds")

##########################################################
#mole <- readRDS("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/mole_reanno.rds")

unique(mole$anno)

#####data check
table(mole$anno, mole$stage)

alldata$mole@meta.data$anno <- "NA"
alldata$mole@meta.data$anno[which(colnames(alldata$mole)%in% colnames(mole)[which(mole$anno=="Epiblast")])] <- "Epiblast"

alldata$mole@meta.data$anno[which(colnames(alldata$mole)%in% colnames(mole)[which(mole$anno=="TE_CTB_STB")])] <- "TE_CTB_STB"
alldata$mole@meta.data$anno[which(colnames(alldata$mole)%in% colnames(mole)[which(mole$anno=="Hypoblast")])] <- "Hypoblast"

unique(alldata$mole@meta.data$anno)
alldata$mole@meta.data$sub_anno <- alldata$mole@meta.data$anno

#####data check
table(alldata$mole$anno, alldata$mole$stage)

rm(mole)

alldata$mole <- subset(alldata$mole, subset = stage!="E12")

```



# read label metadata
```{r, hight=3, weight=3}

#labmeta <- read_excel("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/data/label_metadata.xlsx")

#unique(labmeta$`pre-label`)

######Ai#############
unique(alldata$Ai$anno)

alldata$Ai$label1 <- alldata$Ai$anno
alldata$Ai$label1[which(alldata$Ai$label1=="AVE_YE")] <- "ExE.Endoderm"
alldata$Ai$label1[which(alldata$Ai$label1=="TE_AME")] <- "TE/TrB"
alldata$Ai$label1[which(alldata$Ai$label1=="ExE.Mesoderm")] <- "ExE.Mesoderm"

unique(alldata$Ai$label1)

######Mole#############
unique(alldata$mole$anno)
alldata$mole$label1 <- alldata$mole$anno
alldata$mole$label1[which(alldata$mole$label1=="TE_CTB_STB")] <- "TE/TrB"
unique(alldata$mole$label1)

######Tyser#############
unique(alldata$tyser$anno)

alldata$tyser$anno <- as.character(alldata$tyser$anno)
alldata$tyser$label1 <- alldata$tyser$anno
alldata$tyser$label1[which(alldata$tyser$label1 %in% c("Erythroblasts","Hemogenic Endothelial Progenitors")   )] <- "Hemogenic.Endothelial.Progenitors"
alldata$tyser$label1[which(alldata$tyser$label1 %in% c("Advanced Mesoderm", "Emergent Mesoderm", "Nascent Mesoderm", "Axial Mesoderm") )]<- "Mesoderm"
alldata$tyser$label1[which(alldata$tyser$label1=="ExE Mesoderm")] <- "ExE.Mesoderm"
alldata$tyser$label1[which(alldata$tyser$label1=="Primitive Streak")] <- "Primitive.streak"
alldata$tyser$label1[which(alldata$tyser$label1=="Non-Neural Ectoderm")] <- "Non-Neural.Ectoderm"

unique(alldata$tyser$label1)

######Xiang#############
unique(alldata$xiang$anno)

alldata$xiang$label1 <- alldata$xiang$anno
alldata$xiang$label1[which(alldata$xiang$label1%in% c("CTB", "STB", "EVT", "ICM"))] <- "TE/TrB"
alldata$xiang$label1[which(alldata$xiang$label1=="Primitive streak")] <- "Primitive.streak"
unique(alldata$xiang$label1)

######Zeng#############
unique(alldata$zeng$sub_anno)
unique(alldata$zeng$anno)

alldata$zeng$anno[which(is.na(alldata$zeng$anno))] <- "NA"
alldata$zeng$sub_anno[which(is.na(alldata$zeng$sub_anno))] <- "NA"

table(alldata$zeng$anno, alldata$zeng$stage)

alldata$zeng$label1 <- alldata$zeng$sub_anno
alldata$zeng$label1[which(alldata$zeng$label1%in% c("Lateral plate Mesoderm 1","Intermediate Mesoderm", "Somite", "Lateral plate Mesoderm 2", "NMP","Paraxial mesoderm","Presomitic Mesoderm","Mesenchyme","Cardiac Myocyte","Myocyte Progenitor"))] <- "Mesoderm"
alldata$zeng$label1[which(alldata$zeng$label1%in% c("Neural tbue 1","Neural Crest", "Neural tbue 2", "Neural tbue 3", "Chondroblast"))] <- "Neural.Ectoderm"
alldata$zeng$label1[which(alldata$zeng$label1%in% c("Endothelium","Erythroid"))] <- "Hemogenic.Endothelial.Progenitors"
unique(alldata$zeng$label1)

alldata$zeng$label1[which(alldata$zeng$label1=="Epithelium")] <- "Epiblast"

unique(alldata$zeng$label1)


```


# generate label metadata
```{r, hight=3, weight=3}

##mole#########################
df_mole<- data.frame("dataset"= rep(c("Mole")),
                      "stage" = rep(c("E9-E11")),
                      "orig.anno" = alldata$mole$anno,             
                      "orig.sub_anno" = alldata$mole$sub_anno,
                      "harmo.anno" = alldata$mole$label1 )

df_mole<- unique(df_mole)

##Zeng#########################
df_zeng<- data.frame("dataset"= rep(c("Zeng")),
                      "stage" = rep(c("CS10")),
                      "orig.anno" = alldata$zeng$anno,             
                      "orig.sub_anno" = alldata$zeng$sub_anno,
                      "harmo.anno" = alldata$zeng$label1 )

df_zeng<- unique(df_zeng)


##Ai#########################
df_Ai<- data.frame("dataset"= rep(c("Ai")),
                      "stage" = rep(c("E10-E14")),
                      "orig.anno" = alldata$Ai$anno,             
                      "orig.sub_anno" = alldata$Ai$sub_anno,
                      "harmo.anno" = alldata$Ai$label1 )

df_Ai<- unique(df_Ai)

##Tyser#########################
df_tyser<- data.frame("dataset"= rep(c("Tyser")),
                      "stage" = rep(c("CS7")),
                      "orig.anno" = alldata$tyser$anno,             
                      "orig.sub_anno" = alldata$tyser$sub_anno,
                      "harmo.anno" = alldata$tyser$label1 )

df_tyser<- unique(df_tyser)

##Xiang#########################
df_xiang<- data.frame("dataset"= rep(c("Xiang")),
                      "stage" = rep(c("E6-E14")),
                      "orig.anno" = alldata$xiang$anno,             
                      "orig.sub_anno" = alldata$xiang$sub_anno,
                      "harmo.anno" = alldata$xiang$label1 )

df_xiang<- unique(df_xiang)

##zhou#########################
df_zhou<- data.frame("dataset"= rep(c("Zhou")),
                      "stage" = rep(c("E6-E14")),
                      "orig.anno" = alldata$zhou$anno,             
                      "orig.sub_anno" = alldata$zhou$sub_anno,
                      "harmo.anno" = alldata$zhou$label1 )

df_zhou<- unique(df_zhou)

#############merge#########################
label_all <- rbind(df_mole,df_zeng,df_Ai,df_tyser,df_xiang,df_zhou )


##error check
label_all$harmo.anno[which(label_all$orig.sub_anno=="PGC")] <- "PGC"
label_all$harmo.anno[which(label_all$orig.sub_anno %in% c("YS Endoderm", "AVE_YE" )   )] <- "ExE.Endoderm"

label_all$orig.anno[which(is.na(label_all$orig.anno))] <- "NA"
label_all$orig.sub_anno[which(is.na(label_all$orig.sub_anno))] <- "NA"
label_all$harmo.anno[which(is.na(label_all$harmo.anno))] <- "NA"

label_all$harmo.anno[which(label_all$harmo.anno=="ExE Mesoderm")] <- "ExE.Mesoderm"
label_all$harmo.anno[which(label_all$harmo.anno=="Epithelium")] <- "Epiblast"

unique(label_all$harmo.anno)

##
unique(label_all$orig.anno)

label_all$orig.anno[which(label_all$orig.anno=="ExE Mesoderm")] <- "ExE.Mesoderm"
label_all$orig.anno[which(label_all$orig.anno %in% c("Primitive streak", "Primitive Streak")   )] <- "Primitive.streak"
label_all$orig.anno[which(label_all$orig.anno=="Hemogenic Endothelial Progenitors")] <- "Hemogenic.Endothelial.Progenitors"
label_all$orig.anno[which(label_all$orig.anno=="EPI")] <- "Epiblast"
label_all$orig.anno[which(label_all$orig.anno=="PE")] <- "Hypoblast"

##
unique(label_all$orig.sub_anno)


label_all$orig.sub_anno[which(label_all$orig.sub_anno=="ExE Mesoderm")] <- "ExE.Mesoderm"
label_all$orig.sub_anno[which(label_all$orig.sub_anno=="Primitive streak")] <- "Primitive.streak"
label_all$orig.sub_anno[which(label_all$orig.sub_anno=="Hemogenic Endothelial Progenitors")] <- "Hemogenic.Endothelial.Progenitors"
label_all$orig.sub_anno[which(label_all$orig.sub_anno=="EPI")] <- "Epiblast"
label_all$orig.sub_anno[which(label_all$orig.sub_anno=="PE")] <- "Hypoblast"


#export label metadata #140

library("xlsx")

setwd("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/data")
outputDir = getwd()


write.xlsx(label_all, file = "label_allmeta.xlsx")

```




#Plot Sankey
```{r Sankey_plot, fig.width=20,fig.height=11}
library(ggforce)

ann_size<-length(colnames(label_all))
ann_names<-c(colnames(label_all))


count_mat <- label_all %>% dplyr::count(label_all[c(ann_names)])
##error check
sum(count_mat$n) ##239



# Feel free to change the order of which colors are appointed.
color<-c("#A349A4", "#FFFF33", "#E7298A", "#091833", "#1B9E77", "#D95F02", "#7570B3",  "#66A61E", "#E6AB02", "#8DD3C7", "#9F000F", "#BEBADA", "#FB8072", "#80B1D3", "#FDB462", "#B3DE69", "#FCCDE5", "#D9D9D9", "#BC80BD", "#CCEBC5", "#FFED6F", "#377EB8", "#984EA3", "#4DAF4A", "#FF71CE", "#FF7F00", "#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#FDBF6F", "#CAB2D6", "#6A3D9A", "#FFFF99", "#B15928",
         "#A349A4", "#FFFF33", "#E7298A", "#091833", "#1B9E77", "#D95F02", "#7570B3",  "#66A61E", "#E6AB02", "#8DD3C7", "#9F000F", "#BEBADA", "#FB8072", "#80B1D3", "#FDB462", "#B3DE69", "#FCCDE5", "#D9D9D9")

# Use count and count_max to set the range of color needed for each column.
# With setNames() the color code is linked to each unique individual value of each column.
count=1
color_list = list()
for (ann in ann_names) {
  count_max = count+length(unique(label_all[[ann]]))-1
  color_list[[ann]]<-setNames(color[count:count_max], unique(label_all[[ann]]))
  count=count_max+1
}

test_gr <- gather_set_data(count_mat, 1:all_of(ann_size))
test_gr$x <- factor(test_gr$x, labels = ann_names)

ggplot(test_gr, height = 10, width = 10, aes(x, id = id, split = y, value = n)) +
  geom_parallel_sets(aes(fill = stage), alpha = 0.5, axis.width = 0.1) +
  geom_parallel_sets_axes(axis.width = 0.2) +
  geom_parallel_sets_labels(color = "white", size = 4) +
  theme_classic(base_size = 12) + 
  theme(legend.position = "bottom",
        axis.ticks.y = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank()) +
  scale_y_continuous(expand = expansion(0)) + 
  scale_x_discrete(expand = expansion(0)) +
  labs(x = "", y = "") +
  scale_fill_manual(values=color_list$stage) +
  annotate(geom = "Segment", x = 4.25, xend = 4.25,
           y = 10, yend = 61, lwd = 2) +
  annotate(geom = "text", x = 4.19, y = 25, angle = 90, size = 5,
           hjust = 0.5, label = "50 segments")


```

#Plot Sankey,adjust metadata
```{r Sankey_plot, fig.width=20,fig.height=11}

#labmeta$stage[which(labmeta$stage %in% c("E9-E11", "E10-E14"))] <- "E9-E14"

lab2 <- label_all[, c(1,2,5)]
unique(lab2$stage)

lab2$stage <- factor(lab2$stage, levels = c("E6-E14","E9-E11","E10-E14", "CS7", "CS10"))

unique(lab2$dataset) 
lab2$dataset <- factor(lab2$dataset, levels = c("Xiang", "Zhou",  "Mole","Ai","Tyser", "Zeng"))

lab2$harmo.anno <- as.character(lab2$harmo.anno)
unique(lab2$harmo.anno)
lab2$harmo.anno <- factor(lab2$harmo.anno, levels = c("TE/TrB", "Epiblast", "Hypoblast", "Primitive.streak", "ExE.Mesoderm" ,  "ExE.Endoderm", "PGC",  "Mesoderm","Endoderm","Notochord", "Non-Neural.Ectoderm","Neural.Ectoderm", "Hemogenic.Endothelial.Progenitors","NA" ))

##################
ann_size<-length(colnames(lab2))
ann_names<-c(colnames(lab2))


count_mat <- lab2 %>% dplyr::count(lab2 [c(ann_names)])
##error check
sum(count_mat$n) ##140


ann_size<-length(colnames(lab2))
ann_names<-c(colnames(lab2))
count_mat <- lab2 %>% dplyr::count(lab2[c(ann_names)])
##error check
sum(count_mat$n) 


test_gr <- gather_set_data(count_mat, 1:all_of(ann_size))
test_gr$x <- factor(test_gr$x, labels = ann_names)

ggplot(test_gr, height = 10, width = 5, aes(x, id = id, split = y, value = n)) +
  geom_parallel_sets(aes(fill = dataset), alpha = 0.5, axis.width = 0.1) +
  geom_parallel_sets_axes(axis.width = 0.1) +
  geom_parallel_sets_labels(color = "red",angle = 0, nudge_x = 0.07, hjust = 0, size = 6) +
  theme_classic(base_size = 30) + 
  theme(legend.position = "bottom",
        axis.ticks.y = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank()) +
  scale_y_continuous(expand = expansion(0)) + 
  scale_x_discrete(expand = expansion(0)) +
  labs(x = "", y = "") +
  #scale_fill_manual(values=color_list$stage) +
  annotate(geom = "Segment", x = 4.25, xend = 4.25,
           y = 10, yend = 61, lwd = 2) +
  annotate(geom = "text", x = 4.19, y = 25, angle = 90, size = 10,
           hjust = 0.5, label = "50 segments")

################remove NA###############################
lab2_nar <- lab2[-which(lab2$harmo.anno=="NA"),]

##################
ann_size<-length(colnames(lab2_nar))
ann_names<-c(colnames(lab2_nar))


count_mat <- lab2_nar %>% dplyr::count(lab2_nar[c(ann_names)])
##error check
sum(count_mat$n) ##140


ann_size<-length(colnames(lab2_nar))
ann_names<-c(colnames(lab2_nar))
count_mat <- lab2_nar %>% dplyr::count(lab2_nar[c(ann_names)])
##error check
sum(count_mat$n) 


test_gr <- gather_set_data(count_mat, 1:all_of(ann_size))
test_gr$x <- factor(test_gr$x, labels = ann_names)

ggplot(test_gr, height = 10, width = 5, aes(x, id = id, split = y, value = n)) +
  geom_parallel_sets(aes(fill = dataset), alpha = 0.5, axis.width = 0.1) +
  geom_parallel_sets_axes(axis.width = 0.1) +
  geom_parallel_sets_labels(color = "red",angle = 0, nudge_x = 0.07, hjust = 0, size = 6) +
  theme_classic(base_size = 30) + 
  theme(legend.position = "bottom",
        axis.ticks.y = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank()) +
  scale_y_continuous(expand = expansion(0)) + 
  scale_x_discrete(expand = expansion(0)) +
  labs(x = "", y = "") +
  #scale_fill_manual(values=color_list$stage) +
  annotate(geom = "Segment", x = 4.25, xend = 4.25,
           y = 10, yend = 61, lwd = 2) +
  annotate(geom = "text", x = 4.19, y = 25, angle = 90, size = 10,
           hjust = 0.5, label = "50 segments")

###################lab1###################

lab1 <- label_all[,-2]

unique(lab1$harmo.anno)
unique(lab1$dataset)
lab1$dataset <- factor(lab1$dataset, levels = c("Xiang", "Zhou",  "Mole","Ai","Tyser", "Zeng"))
lab1$harmo.anno <- factor(lab1$harmo.anno, levels = c("TE/TrB", "Epiblast", "Hypoblast", "Primitive.streak", "ExE.Mesoderm" ,  "ExE.Endoderm", "PGC",  "Mesoderm","Endoderm","Notochord", "Non-Neural.Ectoderm","Neural.Ectoderm", "Hemogenic.Endothelial.Progenitors","NA" ))


lab1<-  lab1[with(lab1, order(dataset, harmo.anno)), ]

lab1$orig.sub_anno[which(lab1$orig.sub_anno=="NA")] <- lab1$orig.anno[which(lab1$orig.sub_anno=="NA")]


##################
ann_size<-length(colnames(lab1))
ann_names<-c(colnames(lab1))


count_mat <- lab1 %>% dplyr::count(lab1 [c(ann_names)])
##error check
sum(count_mat$n) ##239


ann_size<-length(colnames(lab1))
ann_names<-c(colnames(lab1))
count_mat <- lab1 %>% dplyr::count(lab1[c(ann_names)])
##error check
sum(count_mat$n) 


test_gr <- gather_set_data(count_mat, 1:all_of(ann_size))
test_gr$x <- factor(test_gr$x, labels = ann_names)

ggplot(test_gr, height = 10, width = 10, aes(x, id = id, split = y, value = n)) +
  geom_parallel_sets(aes(fill = dataset), alpha = 0.5, axis.width = 0.1) +
  geom_parallel_sets_axes(axis.width = 0.1) +
  geom_parallel_sets_labels(color = "red",angle = 0, nudge_x = 0.07, hjust = 0, size = 6) +
  theme_classic(base_size = 30) + 
  theme(legend.position = "bottom",
        axis.ticks.y = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank()) +
  scale_y_continuous(expand = expansion(0)) + 
  scale_x_discrete(expand = expansion(0)) +
  labs(x = "", y = "") +
  #scale_fill_manual(values=color_list$stage) +
  annotate(geom = "Segment", x = 4.25, xend = 4.25,
           y = 10, yend = 61, lwd = 2) +
  annotate(geom = "text", x = 4.19, y = 25, angle = 90, size = 10,
           hjust = 0.5, label = "50 segments")

##############################################

lab1 <- label_all[,3:5]

lab1$harmo.anno <- as.character(lab1$harmo.anno)
unique(lab1$harmo.anno)

lab1$harmo.anno <- factor(lab1$harmo.anno, levels = c("TE/TrB", "Epiblast", "Hypoblast", "Primitive.streak", "ExE.Mesoderm" ,  "ExE.Endoderm", "PGC",  "Mesoderm","Endoderm","Notochord", "Non-Neural.Ectoderm","Neural.Ectoderm", "Hemogenic.Endothelial.Progenitors","NA" ))


lab1$orig.sub_anno[which(lab1$orig.sub_anno=="NA")] <- lab1$orig.anno[which(lab1$orig.sub_anno=="NA")]

unique(lab1$orig.anno)

lab1$orig.anno <- factor(lab1$orig.anno, levels = c("TE","TE_AME", "TE_CTB_STB" ,"CTB", "STB","EVT", "ICM", "Epiblast","Epithelium", "Primitive.streak","Notochord", "Neural Crest", "Non-Neural Ectoderm" ,"NSC","Glu N","DA N","IPC","NMP" ,"Emergent Mesoderm","Nascent Mesoderm", "MesoPro","LPM","Axial Mesoderm"  ,"Advanced Mesoderm", "ExE.Mesoderm" ,"Myoblast", "Chondroblast","Hemogenic.Endothelial.Progenitors","Immune Cell", "Erythroblasts" , "Erythroid", "Endothelium",  "Hypoblast", "Endoderm" ,  "AVE_YE" ,"MIX", "NA" ) ) 

lab1<-  lab1[with(lab1, order( harmo.anno, orig.anno)), ]

unique(lab1$orig.sub_anno)

lab1$orig.sub_anno <- factor(lab1$orig.sub_anno, levels = unique(lab1$orig.sub_anno) ) 


##################
ann_size<-length(colnames(lab1))
ann_names<-c(colnames(lab1))


count_mat <- lab1 %>% dplyr::count(lab1 [c(ann_names)])
##error check
sum(count_mat$n) ##239


ann_size<-length(colnames(lab1))
ann_names<-c(colnames(lab1))
count_mat <- lab1 %>% dplyr::count(lab1[c(ann_names)])
##error check
sum(count_mat$n) 


test_gr <- gather_set_data(count_mat, 1:all_of(ann_size))
test_gr$x <- factor(test_gr$x, labels = ann_names)

p <- ggplot(test_gr, height = 15, width = 10, aes(x, id = id, split = y, value = n)) +
  geom_parallel_sets(aes(fill = harmo.anno), alpha = 0.5, axis.width = 0.1) +
  geom_parallel_sets_axes(axis.width = 0.1) +
  geom_parallel_sets_labels(color = "red",angle = 0, nudge_x = 0.07, hjust = 0, size = 5) +
  theme_classic(base_size = 30) + 
  theme(legend.position = "bottom",
        axis.ticks.y = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank()) +
  scale_y_continuous(expand = expansion(0)) + 
  scale_x_discrete(expand = expansion(0)) +
  labs(x = "", y = "") +
  #scale_fill_manual(values=color_list$stage) +
  annotate(geom = "Segment", x = 4.25, xend = 4.25,
           y = 10, yend = 61, lwd = 2) +
  annotate(geom = "text", x = 4.19, y = 25, angle = 90, size = 10,
           hjust = 0.5, label = "50 segments")


ggsave("p.pdf",height=12, width = 20 )

###########remove NA##########################################
lab1_nar <- lab1[-which(lab1$harmo.anno=="NA"),]

##################
ann_size<-length(colnames(lab1_nar))
ann_names<-c(colnames(lab1_nar))


count_mat <- lab1_nar %>% dplyr::count(lab1_nar[c(ann_names)])
##error check
sum(count_mat$n) ##239


ann_size<-length(colnames(lab1_nar))
ann_names<-c(colnames(lab1_nar))
count_mat <- lab1_nar %>% dplyr::count(lab1_nar[c(ann_names)])
##error check
sum(count_mat$n) 


test_gr <- gather_set_data(count_mat, 1:all_of(ann_size))
test_gr$x <- factor(test_gr$x, labels = ann_names)

p <- ggplot(test_gr, height = 15, width = 10, aes(x, id = id, split = y, value = n)) +
  geom_parallel_sets(aes(fill = harmo.anno), alpha = 0.5, axis.width = 0.1) +
  geom_parallel_sets_axes(axis.width = 0.1) +
  geom_parallel_sets_labels(color = "red",angle = 0, nudge_x = 0.07, hjust = 0, size = 5) +
  theme_classic(base_size = 30) + 
  theme(legend.position = "bottom",
        axis.ticks.y = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank()) +
  scale_y_continuous(expand = expansion(0)) + 
  scale_x_discrete(expand = expansion(0)) +
  labs(x = "", y = "") +
  #scale_fill_manual(values=color_list$stage) +
  annotate(geom = "Segment", x = 4.25, xend = 4.25,
           y = 10, yend = 61, lwd = 2) +
  annotate(geom = "text", x = 4.19, y = 25, angle = 90, size = 10,
           hjust = 0.5, label = "50 segments")


ggsave("p.pdf",height=12, width = 20 )

##########summary######################
length(unique(label_all$orig.anno))
length(unique(label_all$orig.sub_anno))
length(unique(label_all$harmo.anno))

```



#correct labels in data object
```{r }

##mole
colnames(alldata$mole@meta.data)[12] <- "harmo.anno"
unique(alldata$mole$anno)
unique(alldata$mole$sub_anno)
unique(alldata$mole$harmo.anno)

##zeng
colnames(alldata$zeng@meta.data)[12] <- "harmo.anno"
unique(alldata$zeng$anno)
unique(alldata$zeng$sub_anno)
unique(alldata$zeng$harmo.anno)

alldata$zeng$anno[which(is.na(alldata$zeng$anno))] <- "NA"
alldata$zeng$sub_anno[which(is.na(alldata$zeng$sub_anno))] <- "NA"
alldata$zeng$harmo.anno[which(is.na(alldata$zeng$harmo.anno))] <- "NA"


##Ai
colnames(alldata$Ai@meta.data)[12] <- "harmo.anno"
unique(alldata$Ai$anno)
unique(alldata$Ai$sub_anno)
unique(alldata$Ai$harmo.anno)

##tyser
colnames(alldata$tyser@meta.data)[12] <- "harmo.anno"
unique(alldata$tyser$anno)
unique(alldata$tyser$sub_anno)
unique(alldata$tyser$harmo.anno)

alldata$tyser$anno[which(alldata$tyser$anno=="Hemogenic Endothelial Progenitors")] <- "Hemogenic.Endothelial.Progenitors"
alldata$tyser$anno[which(alldata$tyser$anno=="ExE Mesoderm")] <- "ExE.Mesoderm"
alldata$tyser$anno[which(alldata$tyser$anno=="Primitive Streak")] <- "Primitive.streak"
alldata$tyser$anno[which(alldata$tyser$anno=="Non-Neural Ectoderm")] <- "Non-Neural.Ectoderm"

alldata$tyser$sub_anno[which(alldata$tyser$sub_anno=="Primitive Streak")] <- "Primitive.streak"

##xiang
colnames(alldata$xiang@meta.data)[12] <- "harmo.anno"
unique(alldata$xiang$anno)
unique(alldata$xiang$sub_anno)
unique(alldata$xiang$harmo.anno)

alldata$xiang$anno[which(alldata$xiang$anno=="Primitive streak")] <- "Primitive.streak"
alldata$xiang$sub_anno[which(alldata$xiang$sub_anno=="Primitive streak")] <- "Primitive.streak"

##zhou
colnames(alldata$zhou@meta.data)[12] <- "harmo.anno"
unique(alldata$zhou$anno)
unique(alldata$zhou$sub_anno)
unique(alldata$zhou$harmo.anno)

alldata$zhou$anno[which(alldata$zhou$anno=="EPI")] <- "Epiblast"
alldata$zhou$anno[which(alldata$zhou$anno=="PE")] <- "Hypoblast"

alldata$zhou$sub_anno[which(alldata$zhou$sub_anno=="EPI")] <- "Epiblast"
alldata$zhou$sub_anno[which(alldata$zhou$sub_anno=="PE")] <- "Hypoblast"


```


#correct embryonic stage
```{r }
######add Zhou stage details########
setwd("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/data/GSE109555_RAW")
getwd()
doc <- list.files()

library(stringr)


df <- do.call(rbind, lapply(1:length(doc), function(x) {
  
data1 <- read.table(gzfile(doc[x]))
 names(data1) <- c('code', 'label')

 file <- str_split_fixed( doc[x], "_", 2)
 file <- str_split_fixed( file, ".txt.gz", 2)[2]
 
 data1$file <- as.character(file)  
  
 return(data1)
}))

df2 <-alldata$zhou@meta.data
df2$id <- rownames(df2)


meta <- do.call(rbind, lapply(unique(df2$sample), function(x) {
  
data1 <- df2[which(df2$sample==x),]
data2 <- df[grep(x, df$file),]

data1$label <- "NA"


for (i in 1:nrow(data1)) {
 
    data1$label[grep(data2$code[i], data1$id )] <- data2$label[i]
   
}

return(data1)


}))

##ERROR CHECK

df$name <- "NA"

for (x in unique(df2$sample)) {
  
data1 <- df2[which(df2$sample==x ),]


data2 <- grep(x, df$file)

if (length(data2)!=0)
  
df$name[grep(x, df$file)]<- x 

}

unique(df$file[which(df$name=="NA")])

unique(meta$source_name[which(meta$label=="NA")])

##not completely match, but they are all from D6
meta$source_name[which(meta$label=="NA")] 


meta <- meta[match(colnames(alldata$zhou), rownames(meta)),]
meta$stage2 <- stringr::str_match(meta$label, "D\\d+")
unique(meta$stage2)
meta$stage2[which(is.na(meta$stage2))] <- "D6"

anno <- read_excel("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/data/Zhou info/Supplementary Table 2 Sample Information.xlsx") #5911 cells

colnames(anno)[1]<-"label"

meta <- merge(meta, anno, by = "label",all.x = TRUE)


#################trio data###########################
anno2 <- read_excel("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/data/Zhou info/Supplementary Table 8 TrioSeq_RNA_part_DataInfo.xlsx") #only 2544 cells

colnames(anno2)[1]<-"label"

meta2 <- meta[which(is.na(meta$Lineage)),]
meta2 <- meta2[, 1:15]


meta2 <- merge(meta2, anno2, by = c("label"),all.x = TRUE)

##error check
length(is.na(meta2$Lineage))
table(meta2$Lineage)

test <- meta2[which(is.na(meta2$Lineage)),] ##3159
which(anno2$label %in%  test$label)

##############################################
any(anno$label %in% anno2$label)

anno <- anno[,c(1:4, 9:10, 13)]
anno2 <- anno2[,c(1:4, 6,8,7)] 

colnames(anno)[5] <- "Day_Emb"

anno.merge <- rbind(anno, anno2)

meta.extra <- meta[,c(1:14)]

meta.extra <- merge(meta.extra, anno.merge, by = "label",all.x = TRUE)

############check#######
length(which(is.na(meta.extra$IVC)))

unique(meta.extra$IVC)

length(which(meta.extra$IVC=="IVC0"))


meta.extra <- meta.extra[match(colnames(alldata$zhou), meta.extra$id),]

alldata$zhou$IVC <- meta.extra$IVC

#####add same metadata to other datasets###############
alldata$mole$IVC <- "NA"
alldata$zeng$IVC <- "NA"
alldata$Ai$IVC <- "NA"
alldata$tyser$IVC <- "NA"
alldata$xiang$IVC <- "NA"


############check stage#############################
unique(alldata$mole$stage)

alldata$mole$stage <- paste(alldata$mole$stage, "_IVC",sep = "")

################
unique(alldata$zeng$stage)

alldata$zeng$stage[which(alldata$zeng$stage=="PCW3")] <- "CS10"

################
unique(alldata$Ai$stage)

alldata$Ai$stage <- paste(alldata$Ai$stage, "_IVC",sep = "")

################
unique(alldata$tyser$stage)

################
unique(alldata$xiang$stage)
alldata$xiang$stage <- paste(alldata$xiang$stage, "_IVC",sep = "")
alldata$xiang$stage <-  gsub("D", "E", alldata$xiang$stage)

alldata$xiang$stage[which(alldata$xiang$stage=="E6_IVC")] <- "E6"

################
unique(alldata$zhou$stage)

alldata$zhou$stage <- paste(alldata$zhou$stage, "_IVC",sep = "")
alldata$zhou$stage <-  gsub("D", "E", alldata$zhou$stage)
alldata$zhou$stage[which(alldata$zhou$IVC=="IVC0")] <- "E6"


saveRDS(alldata, file = "all_reanno_E12removed.rds")

rm(alldata)

```






#####
```{r Sankey_plot, fig.width=20,fig.height=11}
#all <- readRDS("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/all_reanno_E12removed.rds")
all <- readRDS("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/data/may_analysis/all_reanno_E12removed.rds")

##double check labels

unique(all$mole$anno)
unique(all$mole$sub_anno)
unique(all$mole$harmo.anno)
unique(all$mole$stage)

table(all$mole$anno,all$mole$stage)

############
unique(all$zeng$anno)
unique(all$zeng$sub_anno)
unique(all$zeng$harmo.anno)
unique(all$zeng$stage)

table(all$zeng$anno,all$zeng$stage)

############
unique(all$Ai$anno)
unique(all$Ai$sub_anno)
unique(all$Ai$harmo.anno)
unique(all$Ai$stage)

table(all$Ai$anno,all$Ai$stage)


############
unique(all$tyser$anno)
unique(all$tyser$sub_anno)
unique(all$tyser$harmo.anno)
unique(all$tyser$stage)

table(all$tyser$anno,all$tyser$stage)

############
unique(all$xiang$anno)
unique(all$xiang$sub_anno)
unique(all$xiang$harmo.anno)
unique(all$xiang$stage)

table(all$xiang$anno,all$xiang$stage)

############
unique(all$zhou$anno)
unique(all$zhou$sub_anno)
unique(all$zhou$harmo.anno)
unique(all$zhou$stage)

table(all$zhou$anno,all$zhou$stage)

```

#convert dataset
```{r Sankey_plot, fig.width=20,fig.height=11}
library(SeuratDisk)
data_list <- c(all$mole, all$zeng, all$Ai, all$tyser, all$xiang, all$zhou)
data_list <- Reduce(merge, data_list)

data_list[["RNA"]] <- as(object = data_list[["RNA"]], Class = "Assay")
SaveH5Seurat(data_list, filename = "data_list.h5Seurat",overwrite = TRUE)
Convert("data_list.h5Seurat", dest = "h5ad", overwrite = TRUE)

```


#check QC param for Zhou dataset
```{r Sankey_plot, fig.width=20,fig.height=11}
##check age#########
  
df <- as.data.frame(table(all$zhou$stage, all$zhou$anno) ) 
df$Var1 <- gsub("D", "E", df$Var1)

colnames(df) <- c("stage", "anno", "Freq")

df$stage<- factor(df$stage, levels = c("E6", "E8", "E10", "E12", "E14"))


# 3: Using RColorBrewer
 library(RColorBrewer) 
colourCount = length(unique(df$anno))
getPalette = colorRampPalette(brewer.pal(5, "Set1"))

ggplot(data=df, aes(x=stage, y=Freq, fill=anno)) +
    geom_bar(stat="identity") +
  scale_fill_manual(values = getPalette(colourCount))+
  theme(axis.text=element_text(size=30),
        axis.title=element_text(size=30,face="bold"),
        legend.text = element_text(size=30),
        legend.title = element_text(size=30))


ggplot(data=df, aes(x=anno, y=Freq, fill=stage)) +
    geom_bar(stat="identity") +
  scale_fill_manual(values = getPalette(colourCount))+
  theme(axis.text=element_text(size=30),
        axis.title=element_text(size=30,face="bold"),
        legend.text = element_text(size=30),
        legend.title = element_text(size=30))



#################subset QC#############################
Zhou <- subset(all$zhou, subset = nFeature_RNA > 2000 & percent.mt < 20)

##check age#########
  
df <- as.data.frame(table(Zhou$stage, Zhou$anno) ) 
df$Var1 <- gsub("D", "E", df$Var1)

colnames(df) <- c("stage", "anno", "Freq")

df$stage<- factor(df$stage, levels = c("E6", "E8", "E10", "E12", "E14"))

ggplot(data=df, aes(x=stage, y=Freq, fill=anno)) +
    geom_bar(stat="identity") +
  scale_fill_manual(values = getPalette(colourCount))+
  theme(axis.text=element_text(size=30),
        axis.title=element_text(size=30,face="bold"),
        legend.text = element_text(size=30),
        legend.title = element_text(size=30))


ggplot(data=df, aes(x=anno, y=Freq, fill=stage)) +
    geom_bar(stat="identity") +
  scale_fill_manual(values = getPalette(colourCount))+
  theme(axis.text=element_text(size=30),
        axis.title=element_text(size=30,face="bold"),
        legend.text = element_text(size=30),
        legend.title = element_text(size=30))



```





#check QC param for Zhou dataset
```{r Sankey_plot, fig.width=20,fig.height=11}

all <- readRDS("E:/afterPHD/Liu-lab/project1-embryo benchmarking/2024April/all_reanno_E12removed.rds")

all$mole <- subset(all$mole, subset = nFeature_RNA > 2000 & percent.mt < 20)
all$zeng <- subset(all$zeng, subset = nFeature_RNA > 2000 & percent.mt < 20)
all$Ai <- subset(all$Ai, subset = nFeature_RNA > 2000 & percent.mt < 20)
all$tyser <- subset(all$tyser, subset = nFeature_RNA > 2000 & percent.mt < 20)
all$xiang <- subset(all$xiang, subset = nFeature_RNA > 2000 & percent.mt < 20)
all$zhou <- subset(all$zhou, subset = nFeature_RNA > 2000 & percent.mt < 20)


###############################


##check age#########

age <- do.call(rbind, lapply(1:length(all), function(x) {
  
df <- as.data.frame(table(all[[x]]$stage) ) 
 df$dataset <- names(all[x])
  
 return(df)
}))

age$Var1 <- gsub("D", "E", age$Var1)

# 3: Using RColorBrewer
 library(RColorBrewer) 
colourCount = length(unique(age$Var1))
getPalette = colorRampPalette(brewer.pal(9, "Set1"))


ggplot(data=age, aes(x=dataset, y=Freq, fill=Var1)) +
    geom_bar(stat="identity") +
  scale_fill_manual(values = getPalette(colourCount)) 

##use proportion###########

age <- do.call(rbind, lapply(unique(age$dataset), function(x) {
  
df <- age[which(age$dataset==x),]
df$perct <- df$Freq/sum(df$Freq)
  
 return(df)
}))

age$dataset <- factor(age$dataset, levels = c("xiang","zhou", "Ai", "mole", "tyser", "zeng"))

colnames(age)[1] <- "stage"

ggplot(data=age, aes(x=dataset, y=perct, fill=stage)) +
    geom_bar(stat="identity") +
  scale_fill_manual(values = getPalette(colourCount)) +
  theme(axis.text=element_text(size=30),
        axis.title=element_text(size=30,face="bold"),
        legend.text = element_text(size=30),
        legend.title = element_text(size=30))


##############n_cells###################

ncells <- do.call(rbind, lapply(1:length(all), function(x) { 

df <- table(names(all[x]), ncol(all[[x]]))
df <- as.data.frame(df)

return(df)
 
}
) )

class(ncells$Var2)
ncells$Var2 <- as.numeric(as.character(ncells$Var2))



ncells$Var1 <- factor(ncells$Var1, levels = c("xiang","zhou", "Ai", "mole", "tyser", "zeng"))
colnames(ncells)<- c("dataset", "n_cells")



ggplot(data=ncells, aes(x=dataset, y=n_cells)) +
    geom_bar(stat="identity") +
  scale_fill_manual(values = getPalette(colourCount)) +
  theme(axis.text=element_text(size=30),
        axis.title=element_text(size=30,face="bold"),
        legend.text = element_text(size=30),
        legend.title = element_text(size=30))








```


``````{r , fig.width=20,fig.height=11}

##check anno#########
anno <- do.call(rbind, lapply(1:length(all), function(x) {
  
df <- as.data.frame(table(all[[x]]$harmo.anno) ) 
 df$dataset <- names(all[x])
  
 return(df)
}))

# 3: Using RColorBrewer
 library(RColorBrewer) 
colourCount = length(unique(anno$Var1))
getPalette = colorRampPalette(brewer.pal(9, "Set1"))


ggplot(data=anno, aes(x=dataset, y=Freq, fill=Var1)) +
    geom_bar(stat="identity") +
  scale_fill_manual(values = getPalette(colourCount)) 

##use proportion###########

anno <- do.call(rbind, lapply(unique(anno$dataset), function(x) {
  
df <- anno[which(anno$dataset==x),]
df$perct <- df$Freq/sum(df$Freq)
  
 return(df)
}))

anno$dataset <- factor(anno$dataset, levels = c("xiang","zhou", "Ai", "mole", "tyser", "zeng"))

colnames(anno)[1] <- "harmo.anno"


ggplot(data=anno, aes(x=dataset, y=perct, fill=harmo.anno)) +
    geom_bar(stat="identity") +
  scale_fill_manual(values = getPalette(colourCount)) +
  theme(axis.text=element_text(size=30),
        axis.title=element_text(size=30,face="bold"),
        legend.text = element_text(size=25),
        legend.title = element_text(size=30))

```









